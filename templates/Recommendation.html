<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personalized Recommendations</title>
  <style>
    /* Base layout */
    * { box-sizing: border-box; }
    html,body { margin:0; padding:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#764ba2; color:#e6edf3; -webkit-font-smoothing:antialiased; }
    .wrap { max-width: 1000px; margin: 28px auto; padding: 0 16px; }
    .header { display:flex; flex-direction:column; gap:6px; margin-bottom:18px; }
    .header h1 { font-size:24px; margin:0; }
    .muted { color:#94a3b8; font-size:13px; margin:0; }

    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card { background:#0f1724; border:1px solid #1f2a3a; border-radius:12px; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.25); }
    h2 { margin:0 0 12px; font-size:18px; }

    .row { display:flex; flex-direction:column; margin-bottom:12px; }
    label { font-size:14px; margin-bottom:6px; opacity:0.9; }
    label span { color:#ef4444; margin-left:6px; }
    input[type="text"], input[type="number"] {
      background:#071022; border:1px solid #233044; color:#e6edf3; border-radius:10px; padding:10px 12px; font-size:14px; outline:none;
    }
    input:focus { border-color:#3b82f6; box-shadow:0 0 0 4px rgba(59,130,246,.08); }

    .f-columns { display:flex; gap:12px; }
    @media (max-width:900px) { .f-columns { flex-direction:column; } }

    .actions { display:flex; gap:10px; margin-top:6px; }
    .btn { background:#2563eb; border:none; color:white; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn:hover { filter:brightness(1.05); }
    .btn.ghost { background:transparent; border:1px solid #334155; color:#e6edf3; }

    .status { padding:10px 12px; border:1px dashed #334155; border-radius:10px; background: rgba(148,163,184,0.04); color:#cbd5e1; }

    .reco-list { display:flex; flex-direction:column; gap:12px; margin-top:12px; }
    .recommend-card { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); border:1px solid #263241; padding:12px; border-radius:10px; display:flex; flex-direction:column; gap:8px; }
    .recommend-card .top { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .recommend-card h3 { margin:0; font-size:16px; color:#e6edf3; }
    .recommend-card .score { font-weight:700; background:#0b1220; padding:6px 8px; border-radius:999px; font-size:13px; border:1px solid #334155; }
    .tags { font-size:13px; color:#94a3b8; }
    .desc { color:#cbd5e1; font-size:14px; margin:4px 0; }
    .reason { font-size:13px; color:#9fb0c9; margin:0; }
    .rec-actions { display:flex; gap:8px; margin-top:8px; }

    .btn.small { padding:6px 8px; border-radius:8px; font-size:13px; }
    .btn.small.ghost { background:transparent; border:1px solid #334155; color:#e6edf3; }

    .badge { display:inline-block; padding:6px 10px; border-radius:999px; background:#0e1722; border:1px solid #2b3a4a; color:#94a3b8; font-size:13px; }

    .hidden { display:none; }
    .cluster-info { background: #0a1f3d; border: 1px solid #1e3a8a; padding: 10px; border-radius: 8px; margin-top: 12px; }
    .cluster-badge { display: inline-block; padding: 4px 8px; background: #1e40af; color: white; border-radius: 999px; font-size: 12px; font-weight: 600; }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <h1>Personalized Offers</h1>
    </header>

    <main class="grid">
      <section class="card">
        <h2>Your Profile</h2>
        <form id="reco-form" autocomplete="on">
          <div class="row">
            <label>User ID (optional)</label>
            <input type="text" name="UserID" placeholder="e.g., user_123 (optional)">
          </div>

          <div class="f-columns">
            <div class="row">
              <label>Age<span>*</span></label>
              <input type="number" name="Age" min="18" max="100" step="1" required placeholder="e.g., 28">
            </div>

            <div class="row">
              <label>Annual Income ($)<span>*</span></label>
              <input type="number" name="Income" min="0" step="1000" required placeholder="e.g., 50000">
            </div>
          </div>

          <div class="f-columns">
            <div class="row">
              <label>Tenure (months)<span>*</span></label>
              <input type="number" name="Tenure" min="0" step="1" required placeholder="e.g., 24">
            </div>

            <div class="row">
              <label>Monthly Transactions<span>*</span></label>
              <input type="number" name="Transactions" min="0" step="1" required placeholder="e.g., 15">
            </div>
          </div>

          <div class="row">
            <label>Credit Limit ($)<span>*</span></label>
            <input type="number" name="CreditLimit" min="0" step="500" required placeholder="e.g., 20000">
          </div>

          <div class="actions">
            <button type="submit" class="btn">Get Recommendations</button>
            <button type="reset" class="btn ghost">Reset</button>
          </div>
        </form>
      </section>

      <section class="card">
        <h2>Recommendations</h2>
        <div id="status" class="status">Fill the form and submit to see personalized recommendations.</div>

        <div id="cluster-info" class="cluster-info hidden">
          <strong>Customer Segment:</strong> <span id="cluster-name" class="cluster-badge"></span>
          <p id="cluster-desc" style="margin: 8px 0 0 0; font-size: 13px; color: #94a3b8;"></p>
        </div>

        <div id="reco-list" class="reco-list hidden" aria-live="polite"></div>
      </section>
    </main>
  </div>

  <script>
    // Simulated ML Model Logic (XGBoost predictions)
    const CLUSTER_PROFILES = {
      0: {
        name: "Budget Conscious",
        description: "Cost-effective solutions, basic banking needs, cashback focus",
        preferences: ["savings", "cashback", "digital", "starter"]
      },
      1: {
        name: "Premium Spender",
        description: "High-value transactions, luxury services, investment opportunities",  
        preferences: ["wealth", "investment", "premium", "travel", "rewards"]
      },
      2: {
        name: "Young Professional",
        description: "Career growth, travel benefits, moderate spending",
        preferences: ["travel", "rewards", "credit_card", "loan", "education"]
      },
      3: {
        name: "Established Saver",
        description: "Long-term relationships, steady transactions, wealth building",
        preferences: ["wealth", "savings", "investment", "private_banking"]
      }
    };

    // Offers Catalog
    const CATALOG = {
      "offer_01": {
        "title": "Basic Savings Account",
        "description": "No fees, cashback on digital payments",
        "tags": ["cashback", "savings", "digital"],
        "cluster_boost": {0: 3, 3: 2}
      },
      "offer_02": {
        "title": "Travel Rewards Credit Card", 
        "description": "Earn points on travel and dining",
        "tags": ["travel", "rewards", "credit_card"],
        "cluster_boost": {1: 3, 2: 4}
      },
      "offer_03": {
        "title": "Premium Banking Package",
        "description": "Exclusive wealth management and concierge",
        "tags": ["wealth", "private_banking", "investment"],
        "cluster_boost": {1: 4, 3: 3}
      },
      "offer_04": {
        "title": "Personal Loan",
        "description": "Quick disbursal, competitive interest rates", 
        "tags": ["loan", "personal", "quick_disbursal"],
        "cluster_boost": {2: 3, 0: 1}
      },
      "offer_05": {
        "title": "Student Starter Kit",
        "description": "Beginner-friendly account with education benefits",
        "tags": ["education", "onboarding", "starter"],
        "cluster_boost": {0: 2, 2: 2}
      },
      "offer_06": {
        "title": "Investment Portfolio",
        "description": "Diversified mutual funds and SIP options",
        "tags": ["investment", "wealth", "sip"],
        "cluster_boost": {1: 4, 3: 4}
      },
      "offer_07": {
        "title": "Digital Wallet Cashback",
        "description": "5% cashback on all digital transactions",
        "tags": ["digital", "cashback", "mobile"],
        "cluster_boost": {0: 3, 2: 2}
      },
      "offer_08": {
        "title": "Business Credit Card",
        "description": "Expense management and business rewards",
        "tags": ["business", "credit_card", "rewards"],
        "cluster_boost": {1: 2, 3: 3}
      }
    };

    // Simulated XGBoost model prediction
    function predictCluster(features) {
      const { Age, Income, Tenure, Transactions, CreditLimit } = features;
      
      // Simplified decision tree logic (mimicking XGBoost behavior)
      let score = 0;
      
      // Age factor
      if (Age < 30) score += 1;
      else if (Age >= 50) score += 3;
      else score += 2;
      
      // Income factor  
      if (Income >= 100000) score += 3;
      else if (Income >= 60000) score += 2;
      else if (Income >= 40000) score += 1;
      
      // Tenure factor
      if (Tenure >= 36) score += 2;
      else if (Tenure >= 12) score += 1;
      
      // Transaction factor
      if (Transactions >= 50) score += 2;
      else if (Transactions >= 20) score += 1;
      
      // Credit limit factor
      if (CreditLimit >= 50000) score += 2;
      else if (CreditLimit >= 25000) score += 1;

      // Map score to cluster (0-3)
      if (score <= 3) return 0;      // Budget Conscious
      else if (score >= 9) return 1; // Premium Spender  
      else if (score <= 6 && Age < 35) return 2; // Young Professional
      else return 3;                 // Established Saver
    }

    // User interaction storage
    let userEvents = JSON.parse(localStorage.getItem('userEvents') || '[]');

    // Generate personalized recommendations
    function generateRecommendations(userId, features) {
      const cluster = predictCluster(features);
      const clusterProfile = CLUSTER_PROFILES[cluster];
      
      // Score each offer
      const scoredOffers = [];
      for (const [offerId, offer] of Object.entries(CATALOG)) {
        let score = 0;
        
        // Base cluster boost
        score += offer.cluster_boost[cluster] || 0;
        
        // Tag preference matching
        const matchingTags = offer.tags.filter(tag => 
          clusterProfile.preferences.includes(tag)
        ).length;
        score += matchingTags * 2;
        
        // User feedback history boost
        const userHistory = userEvents.filter(e => 
          e.userId === userId && offer.tags.some(tag => e.tags.includes(tag))
        );
        
        userHistory.forEach(event => {
          if (event.eventType === 'accept') score += 5;
          else if (event.eventType === 'click') score += 2;
        });
        
        // Add some randomness to prevent identical results
        score += Math.random() * 0.5;
        
        scoredOffers.push({
          id: offerId,
          ...offer,
          personalization_score: Math.max(0, score / 10), // Normalize to 0-1
          cluster: cluster,
          reason: generateReason(offer, clusterProfile, matchingTags)
        });
      }
      
      // Sort by score and return top 4
      return {
        offers: scoredOffers.sort((a, b) => b.personalization_score - a.personalization_score).slice(0, 4),
        cluster: cluster,
        clusterProfile: clusterProfile
      };
    }

    // Generate explanation for recommendation
    function generateReason(offer, clusterProfile, matchingTags) {
      const reasons = [
        `Perfect match for ${clusterProfile.name} customers`,
        `Recommended based on your customer segment: ${clusterProfile.name}`,
        `Popular among customers with similar profile`,
        `Tailored for your financial goals and spending patterns`
      ];
      
      if (matchingTags > 0) {
        reasons.push(`Matches ${matchingTags} of your key preferences`);
      }
      
      return reasons[Math.floor(Math.random() * reasons.length)];
    }

    // Record user feedback
    function recordFeedback(userId, offerId, eventType, tags) {
      const event = {
        timestamp: new Date().toISOString(),
        userId: userId || 'anonymous',
        offerId: offerId,
        eventType: eventType,
        tags: tags
      };
      
      userEvents.push(event);
      localStorage.setItem('userEvents', JSON.stringify(userEvents));
    }

    // DOM helpers
    function show(el) { el.classList.remove("hidden"); }
    function hide(el) { el.classList.add("hidden"); }

    // Convert form to object
    function formToJSON(form) {
      const fd = new FormData(form);
      const obj = {};
      for (const [k, v] of fd.entries()) {
        if (["Age","Income","Tenure","Transactions","CreditLimit"].includes(k)) {
          obj[k] = v === "" ? null : Number(v);
        } else {
          obj[k] = v;
        }
      }
      return obj;
    }

    // Create offer card
    function createOfferCard(rec, userId) {
      const card = document.createElement("div");
      card.className = "recommend-card";

      const top = document.createElement("div");
      top.className = "top";

      const title = document.createElement("h3");
      title.textContent = rec.title || rec.name || "Offer";

      const score = document.createElement("div");
      score.className = "score";
      score.textContent = `${Math.round(rec.personalization_score * 100)}%`;

      top.appendChild(title);
      top.appendChild(score);
      card.appendChild(top);

      if (rec.description) {
        const desc = document.createElement("div");
        desc.className = "desc";
        desc.textContent = rec.description;
        card.appendChild(desc);
      }

      if (rec.tags && rec.tags.length) {
        const tags = document.createElement("div");
        tags.className = "tags";
        tags.textContent = rec.tags.join(", ");
        card.appendChild(tags);
      }

      const reason = document.createElement("p");
      reason.className = "reason";
      reason.textContent = rec.reason;
      card.appendChild(reason);

      // Actions
      const actions = document.createElement("div");
      actions.className = "rec-actions";

      const acceptBtn = document.createElement("button");
      acceptBtn.className = "btn small";
      acceptBtn.textContent = "Accept";

      acceptBtn.addEventListener("click", () => {
        acceptBtn.disabled = true;
        acceptBtn.textContent = "Accepted ✓";
        recordFeedback(userId, rec.id, 'accept', rec.tags);
      });

      const viewBtn = document.createElement("button");
      viewBtn.className = "btn small ghost";
      viewBtn.textContent = "I viewed this";
      
      viewBtn.addEventListener("click", () => {
        viewBtn.disabled = true;
        viewBtn.textContent = "Recorded";
        recordFeedback(userId, rec.id, 'click', rec.tags);
      });

      actions.appendChild(acceptBtn);
      actions.appendChild(viewBtn);
      card.appendChild(actions);

      return card;
    }

    // Main application logic
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("reco-form");
      const status = document.getElementById("status");
      const recoList = document.getElementById("reco-list");
      const clusterInfo = document.getElementById("cluster-info");
      const clusterName = document.getElementById("cluster-name");
      const clusterDesc = document.getElementById("cluster-desc");

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        status.textContent = "Running model predictions...";
        show(status);
        hide(recoList);
        hide(clusterInfo);

        try {
          const payload = formToJSON(form);
          const userId = payload.UserID || 'anonymous';
          
          // Simulate API delay
          setTimeout(() => {
            const result = generateRecommendations(userId, payload);
            
            // Show cluster information
            clusterName.textContent = result.clusterProfile.name;
            clusterDesc.textContent = result.clusterProfile.description;
            show(clusterInfo);
            
            // Clear and render recommendations
            recoList.innerHTML = "";
            
            if (!result.offers.length) {
              status.textContent = "No offers matched your profile right now.";
              show(status);
              return;
            }

            result.offers.forEach(rec => {
              const card = createOfferCard(rec, userId);
              recoList.appendChild(card);
            });

            hide(status);
            show(recoList);
            
          }, 1500); // Simulate processing time
          
        } catch (err) {
          status.textContent = "Error: " + err.message;
          show(status);
          hide(recoList);
          hide(clusterInfo);
        }
      });
    });
  </script>
</body>
</html>
